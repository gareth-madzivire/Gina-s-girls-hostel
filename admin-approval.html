<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gina's Hostel - Approval Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideInRight { animation: slideInRight 0.3s ease-out; }
        .status-pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .status-approved { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .status-rejected { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .approval-card {
            transition: all 0.2s;
        }
        .approval-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .capacity-meter {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            position: relative;
        }
        .capacity-indicator {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-slate-100 min-h-screen">
    <!-- Check admin authentication -->
    <script>
        const loggedIn = localStorage.getItem('adminLoggedIn');
        if (!loggedIn) {
            window.location.href = 'index.html';
        }
    </script>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-900 to-blue-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="admin-portal.html" class="flex items-center gap-2 text-white hover:text-blue-200 transition">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Admin Portal</span>
                    </a>
                    <div class="h-6 w-px bg-white/30"></div>
                    <div>
                        <h1 class="text-2xl font-bold">Approval Interface</h1>
                        <p class="text-sm opacity-90">Review and approve resident applications</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div id="currentTime" class="text-sm"></div>
                        <div class="text-xs opacity-80" id="currentDate"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Emergency Banner -->
    <div class="bg-gradient-to-r from-red-600 to-red-700 text-white py-2">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-center gap-2">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="text-sm">
                    Emergency Contacts Available: Caretaker Garry 
                    <a href="tel:+263711391414" class="font-bold underline">+263 71 139 1414</a>
                </span>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Column - Stats & Capacity -->
            <div class="lg:col-span-1">
                <!-- Capacity Overview -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="font-bold text-slate-800 mb-4">Capacity Overview</h3>
                    
                    <div class="space-y-4">
                        <!-- Capacity Meter -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-slate-600">Current</span>
                                <span class="font-bold text-slate-800" id="currentOccupancy">0</span>
                                <span class="text-slate-600">Max: 13</span>
                            </div>
                            <div class="capacity-meter">
                                <div id="capacityIndicator" class="capacity-indicator" style="left: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500 mt-1">
                                <span>Empty</span>
                                <span>Half</span>
                                <span>Full</span>
                            </div>
                        </div>
                        
                        <!-- Capacity Stats -->
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Available Spots</span>
                                <span id="availableSpots" class="font-bold text-emerald-600">13</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Pending Applications</span>
                                <span id="pendingApplications" class="font-bold text-amber-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Approval Rate</span>
                                <span id="approvalRate" class="font-bold text-blue-600">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold text-slate-800 mb-4">Quick Actions</h3>
                    
                    <div class="space-y-3">
                        <button onclick="approveAll()" 
                                class="w-full text-left p-3 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100 transition">
                            <i class="fas fa-check-circle text-emerald-600 mr-2"></i>
                            Approve All Eligible
                        </button>
                        
                        <button onclick="viewAllResidents()" 
                                class="w-full text-left p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition">
                            <i class="fas fa-users text-blue-600 mr-2"></i>
                            View All Residents
                        </button>
                        
                        <button onclick="checkCapacityStatus()" 
                                class="w-full text-left p-3 bg-amber-50 border border-amber-200 rounded-lg hover:bg-amber-100 transition">
                            <i class="fas fa-exclamation-triangle text-amber-600 mr-2"></i>
                            Check Capacity
                        </button>
                        
                        <button onclick="sendBulkWhatsApp()" 
                                class="w-full text-left p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition">
                            <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                            Send Approval Notifications
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column - Applications -->
            <div class="lg:col-span-3">
                <!-- Applications Header -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Pending Applications</h2>
                            <p class="text-slate-600">Review and approve resident check-in requests</p>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <div class="text-3xl font-bold text-amber-600" id="totalPending">0</div>
                                <div class="text-sm text-slate-600">awaiting review</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Bar -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <button onclick="filterApplications('all')" 
                                class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">
                            All Applications
                        </button>
                        <button onclick="filterApplications('today')" 
                                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition">
                            Today's
                        </button>
                        <button onclick="filterApplications('week')" 
                                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition">
                            This Week
                        </button>
                        <div class="ml-auto">
                            <input type="text" id="searchApplications" 
                                   class="border border-slate-300 rounded-lg px-4 py-2 text-sm"
                                   placeholder="Search applications...">
                        </div>
                    </div>
                </div>
                
                <!-- Applications Grid -->
                <div id="applicationsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Applications will be loaded here -->
                </div>
                
                <!-- No Applications Message -->
                <div id="noApplications" class="text-center py-12 hidden">
                    <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                    <h3 class="text-xl font-bold text-slate-700 mb-2">No Pending Applications</h3>
                    <p class="text-slate-600">All applications have been processed. Check back later for new submissions.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Application Detail Modal -->
    <div id="applicationDetailModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full animate-fadeIn">
            <div id="modalHeader" class="text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Application Details</h3>
                    <button onclick="hideApplicationDetail()" class="text-white hover:text-white/80">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div id="applicationDetailContent">
                    <!-- Application details will be loaded here -->
                </div>
            </div>
            
            <div class="p-6 border-t border-slate-200">
                <div class="flex justify-end gap-3">
                    <button onclick="rejectApplication()" 
                            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-times mr-2"></i>
                        Reject
                    </button>
                    <button onclick="approveApplication()" 
                            class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                        <i class="fas fa-check mr-2"></i>
                        Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Assignment Modal -->
    <div id="roomAssignmentModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-fadeIn">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Assign Room</h3>
                    <button onclick="hideRoomAssignment()" class="text-white hover:text-blue-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="roomAssignmentForm" class="space-y-4">
                    <input type="hidden" id="assignResidentId">
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">
                            Select Room <span class="text-red-500">*</span>
                        </label>
                        <select id="roomNumber" required 
                                class="w-full border border-slate-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">Choose a room</option>
                            <optgroup label="Ensuite Rooms">
                                <option value="Ensuite 1">Ensuite 1 (Capacity: 2)</option>
                                <option value="Ensuite 2">Ensuite 2 (Capacity: 2)</option>
                            </optgroup>
                            <optgroup label="Single Rooms">
                                <option value="Blue White">Blue White</option>
                                <option value="Black Gold">Black Gold</option>
                            </optgroup>
                            <optgroup label="Crystal Rooms">
                                <option value="Crystal 1">Crystal 1 (Capacity: 2)</option>
                                <option value="Crystal 2">Crystal 2 (Capacity: 2)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">
                            Monthly Rent ($) <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="monthlyRent" required step="0.01"
                               class="w-full border border-slate-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">
                            Additional Notes
                        </label>
                        <textarea id="roomNotes" rows="3"
                               class="w-full border border-slate-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit"
                                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>
                            Assign Room & Approve
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentApplication = null;
        let allApplications = [];
        
        // Load applications
        function loadApplications() {
            try {
                const pendingResidents = JSON.parse(localStorage.getItem('pendingResidents') || '[]');
                const approvedResidents = JSON.parse(localStorage.getItem('approvedResidents') || '[]');
                
                allApplications = pendingResidents;
                
                // Update counts
                document.getElementById('totalPending').textContent = pendingResidents.length;
                document.getElementById('pendingApplications').textContent = pendingResidents.length;
                
                // Update capacity stats
                updateCapacityStats(approvedResidents.length, pendingResidents.length);
                
                // Display applications
                displayApplications(pendingResidents);
                
            } catch (e) {
                console.error('Error loading applications:', e);
            }
        }
        
        // Update capacity statistics
        function updateCapacityStats(currentResidents, pendingApplications) {
            const maxCapacity = 13;
            const availableSpots = Math.max(0, maxCapacity - currentResidents);
            const occupancyPercent = (currentResidents / maxCapacity) * 100;
            
            document.getElementById('currentOccupancy').textContent = currentResidents;
            document.getElementById('availableSpots').textContent = availableSpots;
            
            // Update capacity indicator
            const indicator = document.getElementById('capacityIndicator');
            indicator.style.left = `${occupancyPercent}%`;
            
            // Calculate approval rate
            const totalProcessed = JSON.parse(localStorage.getItem('totalProcessed') || '0');
            const totalApproved = JSON.parse(localStorage.getItem('totalApproved') || '0');
            const approvalRate = totalProcessed > 0 ? Math.round((totalApproved / totalProcessed) * 100) : 0;
            document.getElementById('approvalRate').textContent = `${approvalRate}%`;
            
            // Show warning if capacity is reached
            if (currentResidents >= maxCapacity) {
                document.getElementById('availableSpots').className = 'font-bold text-red-600';
            } else if (currentResidents >= maxCapacity - 3) {
                document.getElementById('availableSpots').className = 'font-bold text-amber-600';
            } else {
                document.getElementById('availableSpots').className = 'font-bold text-emerald-600';
            }
        }
        
        // Display applications
        function displayApplications(applications) {
            const grid = document.getElementById('applicationsGrid');
            const noApplicationsDiv = document.getElementById('noApplications');
            
            if (applications.length === 0) {
                grid.innerHTML = '';
                noApplicationsDiv.classList.remove('hidden');
                return;
            }
            
            noApplicationsDiv.classList.add('hidden');
            
            // Sort by date (newest first)
            applications.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
            
            grid.innerHTML = applications.map(application => {
                const daysAgo = Math.floor((new Date() - new Date(application.requestedAt)) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="approval-card bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">${application.fullName}</h4>
                                    <div class="text-sm text-slate-600">Applied ${daysAgo === 0 ? 'today' : daysAgo === 1 ? 'yesterday' : `${daysAgo} days ago`}</div>
                                </div>
                            </div>
                            <span class="px-3 py-1 text-xs font-medium rounded-full bg-amber-100 text-amber-800">
                                Pending
                            </span>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-phone text-slate-400"></i>
                                <span>${application.phone}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-university text-slate-400"></i>
                                <span>${application.institution}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-id-card text-slate-400"></i>
                                <span>ID: ${application.idNumber}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="viewApplication('${application.id}')" 
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-eye mr-2"></i>
                                View
                            </button>
                            <button onclick="quickApprove('${application.id}')" 
                                    class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                <i class="fas fa-check mr-2"></i>
                                Approve
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View application details
        function viewApplication(applicationId) {
            try {
                const application = allApplications.find(app => app.id === applicationId);
                if (!application) return;
                
                currentApplication = application;
                
                // Update modal header
                const modalHeader = document.getElementById('modalHeader');
                modalHeader.className = 'status-pending text-white p-6 rounded-t-2xl';
                
                // Load application details
                const content = document.getElementById('applicationDetailContent');
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Personal Information -->
                        <div>
                            <h4 class="font-bold text-slate-800 mb-3">Personal Information</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="text-sm text-slate-500">Full Name</div>
                                    <div class="font-medium text-slate-800">${application.fullName}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-slate-500">Phone Number</div>
                                    <div class="font-medium text-slate-800">${application.phone}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-slate-500">Email Address</div>
                                    <div class="font-medium text-slate-800">${application.email || 'Not provided'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-slate-500">ID/Passport Number</div>
                                    <div class="font-medium text-slate-800">${application.idNumber}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Institution & Preferences -->
                        <div>
                            <h4 class="font-bold text-slate-800 mb-3">Institution & Preferences</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="text-sm text-slate-500">Institution/School</div>
                                    <div class="font-medium text-slate-800">${application.institution}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-slate-500">Preferred Room Type</div>
                                    <div class="font-medium text-slate-800">${application.preferredRoom || 'Any available'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-slate-500">Application Date</div>
                                    <div class="font-medium text-slate-800">${new Date(application.requestedAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Emergency Contacts -->
                        <div class="md:col-span-2">
                            <h4 class="font-bold text-slate-800 mb-3">Emergency Contacts</h4>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-sm text-red-700">Emergency Contact Name</div>
                                        <div class="font-medium text-red-900">${application.emergencyName}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-red-700">Emergency Contact Phone</div>
                                        <div class="font-medium text-red-900">${application.emergencyPhone}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Application Timeline -->
                        <div class="md:col-span-2">
                            <h4 class="font-bold text-slate-800 mb-3">Application Timeline</h4>
                            <div class="space-y-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="fas fa-paper-plane text-blue-600"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-800">Application Submitted</div>
                                        <div class="text-sm text-slate-600">${new Date(application.requestedAt).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center">
                                        <i class="fas fa-clock text-amber-600"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-800">Status: Pending Review</div>
                                        <div class="text-sm text-slate-600">Awaiting admin approval</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show modal
                document.getElementById('applicationDetailModal').classList.remove('hidden');
                
            } catch (e) {
                console.error('Error viewing application:', e);
            }
        }
        
        // Hide application detail
        function hideApplicationDetail() {
            document.getElementById('applicationDetailModal').classList.add('hidden');
            currentApplication = null;
        }
        
        // Approve application
        function approveApplication() {
            if (!currentApplication) return;
            
            // Check capacity before approving
            const approvedResidents = JSON.parse(localStorage.getItem('approvedResidents') || '[]');
            if (approvedResidents.length >= 13) {
                alert('Cannot approve: Hostel is at full capacity (13 residents)');
                return;
            }
            
            // Show room assignment modal
            document.getElementById('assignResidentId').value = currentApplication.id;
            document.getElementById('roomAssignmentModal').classList.remove('hidden');
            document.getElementById('applicationDetailModal').classList.add('hidden');
        }
        
        // Quick approve
        function quickApprove(applicationId) {
            const application = allApplications.find(app => app.id === applicationId);
            if (!application) return;
            
            currentApplication = application;
            approveApplication();
        }
        
        // Reject application
        function rejectApplication() {
            if (!currentApplication || !confirm('Are you sure you want to reject this application?')) return;
            
            try {
                const pendingResidents = JSON.parse(localStorage.getItem('pendingResidents') || '[]');
                const index = pendingResidents.findIndex(r => r.id === currentApplication.id);
                
                if (index === -1) return;
                
                // Remove from pending
                pendingResidents.splice(index, 1);
                localStorage.setItem('pendingResidents', JSON.stringify(pendingResidents));
                
                // Update statistics
                const totalProcessed = JSON.parse(localStorage.getItem('totalProcessed') || '0');
                localStorage.setItem('totalProcessed', (totalProcessed + 1).toString());
                
                // Log activity
                const activityLog = JSON.parse(localStorage.getItem('adminActivityLog') || '[]');
                activityLog.push({
                    timestamp: new Date().toISOString(),
                    action: 'Application Rejected',
                    details: `Rejected ${currentApplication.fullName}'s application`,
                    user: 'Admin'
                });
                localStorage.setItem('adminActivityLog', JSON.stringify(activityLog));
                
                // Send rejection notification via WhatsApp
                sendWhatsAppNotification(currentApplication.phone,
                    `Hello ${currentApplication.firstName}, we regret to inform you that your check-in request for Gina's Hostel has not been approved at this time.`);
                
                // Hide modal and refresh
                hideApplicationDetail();
                loadApplications();
                
                alert(`Application rejected. WhatsApp notification sent to ${currentApplication.fullName}.`);
                
            } catch (e) {
                console.error('Error rejecting application:', e);
                alert('Error rejecting application');
            }
        }
        
        // Handle room assignment form
        document.getElementById('roomAssignmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentApplication) return;
            
            const roomNumber = document.getElementById('roomNumber').value;
            const monthlyRent = document.getElementById('monthlyRent').value;
            const notes = document.getElementById('roomNotes').value;
            
            try {
                const pendingResidents = JSON.parse(localStorage.getItem('pendingResidents') || '[]');
                const approvedResidents = JSON.parse(localStorage.getItem('approvedResidents') || '[]');
                
                // Find and update application
                const index = pendingResidents.findIndex(r => r.id === currentApplication.id);
                if (index === -1) return;
                
                const application = pendingResidents[index];
                
                // Update application status
                application.status = 'approved';
                application.approvedAt = new Date().toISOString();
                application.checkinDate = new Date().toISOString();
                application.roomAssigned = roomNumber;
                application.monthlyRent = monthlyRent;
                application.roomNotes = notes;
                
                // Move from pending to approved
                pendingResidents.splice(index, 1);
                approvedResidents.push(application);
                
                // Save changes
                localStorage.setItem('pendingResidents', JSON.stringify(pendingResidents));
                localStorage.setItem('approvedResidents', JSON.stringify(approvedResidents));
                
                // Update statistics
                const totalProcessed = JSON.parse(localStorage.getItem('totalProcessed') || '0');
                const totalApproved = JSON.parse(localStorage.getItem('totalApproved') || '0');
                localStorage.setItem('totalProcessed', (totalProcessed + 1).toString());
                localStorage.setItem('totalApproved', (totalApproved + 1).toString());
                
                // Log activity
                const activityLog = JSON.parse(localStorage.getItem('adminActivityLog') || '[]');
                activityLog.push({
                    timestamp: new Date().toISOString(),
                    action: 'Application Approved',
                    details: `Approved ${application.fullName} and assigned room ${roomNumber}`,
                    user: 'Admin'
                });
                localStorage.setItem('adminActivityLog', JSON.stringify(activityLog));
                
                // Send WhatsApp notification
                sendWhatsAppNotification(application.phone,
                    `Hello ${application.firstName}, your check-in request for Gina's Hostel has been approved! ` +
                    `You have been assigned to room ${roomNumber}. Monthly rent: $${monthlyRent}. ` +
                    `You can now log in to your dashboard at [Your Portal Link] using your phone number and password.`);
                
                // Hide modal and refresh
                hideRoomAssignment();
                this.reset();
                loadApplications();
                
                alert(`Application approved! Room ${roomNumber} assigned. WhatsApp notification sent.`);
                
            } catch (e) {
                console.error('Error approving application:', e);
                alert('Error approving application');
            }
        });
        
        // Hide room assignment modal
        function hideRoomAssignment() {
            document.getElementById('roomAssignmentModal').classList.add('hidden');
            document.getElementById('roomAssignmentForm').reset();
        }
        
        // Approve all eligible applications
        function approveAll() {
            const approvedResidents = JSON.parse(localStorage.getItem('approvedResidents') || '[]');
            const availableSpots = 13 - approvedResidents.length;
            
            if (availableSpots <= 0) {
                alert('Cannot approve any applications: Hostel is at full capacity.');
                return;
            }
            
            if (!confirm(`Approve up to ${availableSpots} applications automatically?`)) return;
            
            try {
                const pendingResidents = JSON.parse(localStorage.getItem('pendingResidents') || '[]');
                const approvedResidents = JSON.parse(localStorage.getItem('approvedResidents') || '[]');
                
                // Get applications to approve (oldest first, up to available spots)
                const applicationsToApprove = pendingResidents
                    .sort((a, b) => new Date(a.requestedAt) - new Date(b.requestedAt))
                    .slice(0, availableSpots);
                
                if (applicationsToApprove.length === 0) {
                    alert('No applications to approve.');
                    return;
                }
                
                // Assign rooms sequentially
                const rooms = ['Ensuite 1', 'Blue White', 'Black Gold', 'Crystal 1', 'Crystal 2', 'Ensuite 2'];
                let roomIndex = 0;
                
                applicationsToApprove.forEach(application => {
                    const room = rooms[roomIndex % rooms.length];
                    roomIndex++;
                    
                    // Update application
                    application.status = 'approved';
                    application.approvedAt = new Date().toISOString();
                    application.checkinDate = new Date().toISOString();
                    application.roomAssigned = room;
                    application.monthlyRent = '200'; // Default rent
                    
                    // Send WhatsApp notification
                    sendWhatsAppNotification(application.phone,
                        `Hello ${application.firstName}, your check-in request for Gina's Hostel has been approved! ` +
                        `You have been assigned to room ${room}. You can now log in to your dashboard.`);
                });
                
                // Update arrays
                const remainingApplications = pendingResidents.filter(app => 
                    !applicationsToApprove.some(a => a.id === app.id)
                );
                
                approvedResidents.push(...applicationsToApprove);
                
                // Save changes
                localStorage.setItem('pendingResidents', JSON.stringify(remainingApplications));
                localStorage.setItem('approvedResidents', JSON.stringify(approvedResidents));
                
                // Update statistics
                const totalProcessed = JSON.parse(localStorage.getItem('totalProcessed') || '0');
                const totalApproved = JSON.parse(localStorage.getItem('totalApproved') || '0');
                localStorage.setItem('totalProcessed', (totalProcessed + applicationsToApprove.length).toString());
                localStorage.setItem('totalApproved', (totalApproved + applicationsToApprove.length).toString());
                
                // Refresh
                loadApplications();
                
                alert(`${applicationsToApprove.length} applications approved automatically! WhatsApp notifications sent.`);
                
            } catch (e) {
                console.error('Error bulk approving:', e);
                alert('Error bulk approving applications');
            }
        }
        
        // View all residents
        function viewAllResidents() {
            window.location.href = 'admin-portal.html#residents';
        }
        
        // Check capacity status
        function checkCapacityStatus() {
            const approvedResidents = JSON.parse(localStorage.getItem('approvedResidents') || '[]');
            const availableSpots = 13 - approvedResidents.length;
            
            if (availableSpots <= 0) {
                alert('❌ Hostel is at FULL CAPACITY (13/13 residents)\n\nNo new check-ins can be accepted until a resident checks out.');
            } else if (availableSpots <= 3) {
                alert(`⚠️ Hostel is NEARING CAPACITY (${approvedResidents.length}/13 residents)\n\nOnly ${availableSpots} spot(s) available.`);
            } else {
                alert(`✅ Hostel has AVAILABLE SPOTS (${approvedResidents.length}/13 residents)\n\n${availableSpots} spot(s) available for new residents.`);
            }
        }
        
        // Send bulk WhatsApp notifications
        function sendBulkWhatsApp() {
            const message = prompt('Enter approval notification message to send to all pending applicants:', 
                'Your application for Gina\'s Hostel is being reviewed. You will be notified of the decision soon.');
            
            if (!message) return;
            
            try {
                const pendingResidents = JSON.parse(localStorage.getItem('pendingResidents') || '[]');
                let sentCount = 0;
                
                pendingResidents.forEach(resident => {
                    sendWhatsAppNotification(resident.phone, message);
                    sentCount++;
                });
                
                alert(`Notification sent to ${sentCount} pending applicants.`);
                
            } catch (e) {
                console.error('Error sending bulk notifications:', e);
            }
        }
        
        // WhatsApp notification function
        function sendWhatsAppNotification(phone, message) {
            // Simulate WhatsApp API call
            const whatsappLog = JSON.parse(localStorage.getItem('whatsappLog') || '[]');
            whatsappLog.push({
                phone: phone,
                message: message,
                timestamp: new Date().toISOString(),
                status: 'sent',
                type: 'approval_notification'
            });
            localStorage.setItem('whatsappLog', JSON.stringify(whatsappLog));
            
            // In a real implementation, this would call a WhatsApp API
            console.log(`WhatsApp to ${phone}: ${message}`);
            
            // For demo purposes, create a clickable link
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phone.replace(/\D/g, '')}?text=${encodedMessage}`;
            
            // Open in new tab (for demo)
            window.open(whatsappUrl, '_blank');
        }
        
        // Filter applications
        function filterApplications(filter) {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday
            
            let filtered = [...allApplications];
            
            switch(filter) {
                case 'today':
                    filtered = filtered.filter(app => 
                        new Date(app.requestedAt).toDateString() === today.toDateString()
                    );
                    break;
                case 'week':
                    filtered = filtered.filter(app => 
                        new Date(app.requestedAt) >= startOfWeek
                    );
                    break;
            }
            
            displayApplications(filtered);
        }
        
        // Search applications
        document.getElementById('searchApplications').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (!searchTerm) {
                displayApplications(allApplications);
                return;
            }
            
            const filtered = allApplications.filter(app => 
                app.fullName.toLowerCase().includes(searchTerm) ||
                app.phone.includes(searchTerm) ||
                app.idNumber.toLowerCase().includes(searchTerm) ||
                app.institution.toLowerCase().includes(searchTerm)
            );
            
            displayApplications(filtered);
        });
        
        // Update time and date
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            document.getElementById('currentDate').textContent = now.toLocaleDateString();
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            if (!localStorage.getItem('adminLoggedIn')) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load applications
            loadApplications();
            
            // Update time every minute
            setInterval(updateDateTime, 60000);
            updateDateTime();
            
            // Auto-refresh every 30 seconds
            setInterval(loadApplications, 30000);
        });
    </script>
</body>
</html>
